#!/bin/bash

if [ $# -lt 2 ]; then
    echo "usage: $(basename $0) input_media timestamps_file [ffmpeg_args]"
    echo "timestamps file format (alternative 1):"
    echo "[HH:]MM:SS <title>"
    echo "[HH:]MM:SS <title>"
    echo "..."
    echo "timestamps file format (alternative 2):"
    echo "<title> [HH:]MM:SS"
    echo "<title> [HH:]MM:SS"
    echo "..."
    exit 1
fi

media=$1
ext="${media##*.}"
tsf=$2
shift 2

# remove leading/trailing spaces
sed -i 's/^[[:space:]]*//;s/[[:space:]]*$//' "$tsf"

# read lines
IFS=$'\n' read -d '' -r -a ts < "$tsf"

# test first line of the file to determine if ts is first or title
ts_first=false
if [[ "${ts[0]%% *}" =~ ^([0-9]{2}:)?[0-9]{2}:[0-9]{2}$ ]] ; then
    ts_first=true  
fi

n=${#ts[@]}
for (( i=0; i<n; i++ )); do
    if $ts_first; then
        from="${ts[$i]%% *}"
        to="${ts[$((i+1))]%% *}"
        name="$((i+1)) - ${ts[$i]#* }.$ext"
    else
        from="${ts[$i]##* }"
        to="${ts[$((i+1))]##* }"
        name="$((i+1)) - ${ts[$i]% *}.$ext"
    fi
    echo "$from - ${to:-xx:xx} | $name"
    if [ -z "$to" ]; then
        ffmpeg -i "$media" -ss "$from" -vcodec copy -acodec copy -y "$name" $* 
    else
        ffmpeg -i "$media" -ss "$from" -to "$to" -vcodec copy -acodec copy -y "$name" $* 
    fi
done
